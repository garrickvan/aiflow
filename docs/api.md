# API 文档

本文档详细说明了智流MCP系统的后端 HTTP API 和 MCP 工具接口。

## 1. 后端 API

### 1.1 基础信息

- **基础 URL**: `http://localhost:9900`（可通过 `-http` 参数自定义）
- **API 路径前缀**: `/api`
- **响应格式**: JSON

### 1.2 响应结构

所有 API 响应都遵循以下结构：

```json
{
  "success": true,          // 操作是否成功
  "message": "操作成功",    // 操作结果消息
  "data": {},              // 响应数据
  "error": "错误信息"       // 错误信息（仅当 success 为 false 时）
}
```

### 1.3 标签 API

#### 1.3.1 获取所有标签

- **请求方法**: GET
- **请求路径**: `/api/tags`
- **请求参数**: 无
- **响应数据**: 标签列表

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "通用工具",
      "createdAt": 1706400000,
      "updatedAt": 1706400000
    }
  ]
}
```

#### 1.3.2 创建标签

- **请求方法**: POST
- **请求路径**: `/api/tags`
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | name   | string | 是 | 标签名称 |

**请求示例**:

```json
{
  "name": "通用工具"
}
```

#### 1.3.3 根据 ID 获取标签

- **请求方法**: GET
- **请求路径**: `/api/tags/{id}`
- **路径参数**: `id` - 标签 ID

#### 1.3.4 更新标签

- **请求方法**: PUT
- **请求路径**: `/api/tags/{id}`
- **路径参数**: `id` - 标签 ID
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | name   | string | 是 | 标签名称 |

#### 1.3.5 删除标签

- **请求方法**: DELETE
- **请求路径**: `/api/tags/{id}`
- **路径参数**: `id` - 标签 ID

### 1.4 技能 API

#### 1.4.1 获取所有技能

- **请求方法**: GET
- **请求路径**: `/api/skills`
- **请求参数**: 无
- **响应数据**: 技能列表（包含标签信息）

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "文本处理",
      "resourceDir": "text_processing",
      "description": "文本处理工具",
      "license": "MIT",
      "compatibility": "Windows, macOS",
      "metadata": "{}",
      "allowedTools": "",
      "createdAt": 1706400000,
      "updatedAt": 1706400000,
      "tags": []
    }
  ]
}
```

#### 1.4.2 创建技能

- **请求方法**: POST
- **请求路径**: `/api/skills`
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | name | string | 是 | 技能名称（1-64字符，小写字母、数字、连字符） |
  | resourceDir | string | 是 | 资源目录（只能包含字母、数字和下划线） |
  | description | string | 是 | 技能描述（1-1024字符） |
  | detail | string | 否 | 技能详情（Markdown格式） |
  | license | string | 否 | 许可证 |
  | compatibility | string | 否 | 兼容性信息 |
  | metadata | string | 否 | 元数据（JSON格式） |
  | allowedTools | string | 否 | 允许的工具列表（空格分隔） |

#### 1.4.3 根据 ID 获取技能

- **请求方法**: GET
- **请求路径**: `/api/skills/{id}`
- **路径参数**: `id` - 技能 ID

#### 1.4.4 更新技能

- **请求方法**: PUT
- **请求路径**: `/api/skills/{id}`
- **路径参数**: `id` - 技能 ID
- **请求参数**: 同创建技能

#### 1.4.5 删除技能（软删除）

- **请求方法**: DELETE
- **请求路径**: `/api/skills/{id}`
- **路径参数**: `id` - 技能 ID
- **说明**: 技能进入回收站，可恢复

#### 1.4.6 恢复回收站中的技能

- **请求方法**: POST
- **请求路径**: `/api/skills/{id}/restore`
- **路径参数**: `id` - 技能 ID

#### 1.4.7 彻底删除技能

- **请求方法**: DELETE
- **请求路径**: `/api/skills/{id}/permanent`
- **路径参数**: `id` - 技能 ID
- **说明**: 永久删除，不可恢复

#### 1.4.8 获取回收站技能列表

- **请求方法**: GET
- **请求路径**: `/api/skills/trash`

#### 1.4.9 导出技能

- **请求方法**: GET
- **请求路径**: `/api/skills/export` 或 `/api/skills/{id}/export`
- **说明**: 导出为 Markdown 格式

### 1.5 任务 API

#### 1.5.1 获取任务列表

- **请求方法**: GET
- **请求路径**: `/api/jobtasks`

#### 1.5.2 创建任务

- **请求方法**: POST
- **请求路径**: `/api/jobtasks`
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | jobNo | string | 是 | 任务编号（格式：JT-项目-日期-序号） |
  | project | string | 是 | 所属项目 |
  | type | string | 是 | 任务类型 |
  | goal | string | 是 | 任务目标 |
  | status | string | 是 | 任务状态 |
  | passAcceptStd | boolean | 否 | 是否通过验收 |
  | executionRecords | string | 否 | 执行记录（JSON数组） |

#### 1.5.3 根据 ID 获取任务

- **请求方法**: GET
- **请求路径**: `/api/jobtasks/{id}`

#### 1.5.4 更新任务

- **请求方法**: PUT
- **请求路径**: `/api/jobtasks/{id}`

#### 1.5.5 删除任务（软删除）

- **请求方法**: DELETE
- **请求路径**: `/api/jobtasks/{id}`

#### 1.5.6 恢复任务

- **请求方法**: POST
- **请求路径**: `/api/jobtasks/{id}/restore`

#### 1.5.7 彻底删除任务

- **请求方法**: DELETE
- **请求路径**: `/api/jobtasks/{id}/permanent`

#### 1.5.8 获取回收站任务列表

- **请求方法**: GET
- **请求路径**: `/api/jobtasks/trash`

#### 1.5.9 获取所有项目列表

- **请求方法**: GET
- **请求路径**: `/api/jobtasks/projects`

#### 1.5.10 批量导出任务

- **请求方法**: POST
- **请求路径**: `/api/jobtasks/export`

### 1.6 文件上传 API

#### 1.6.1 上传文件

- **请求方法**: POST
- **请求路径**: `/api/upload_data`
- **请求参数**:
  - **FormData 参数**:
    | 参数名 | 类型 | 必填 | 描述 |
    |--------|------|------|------|
    | process_type | string | 否 | 处理类型，默认值：`import_skill` |
    | file | file | 是 | 要上传的文件（支持 .md 和 .zip 格式） |

## 2. MCP 工具

智流MCP通过 MCP 协议提供以下工具供 AI 调用：

### 2.1 技能管理工具

#### 2.1.1 查询技能列表

- **工具名称**: `skill_get`
- **工具描述**: 查技能
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | tag | string | 是 | 要查看的技能标签，不传参则返回全部技能 |
  | keyword | string | 否 | 要查询的技能关键词，不传参则返回全部技能 |

**输入示例**:

```json
{
  "tag": "",
  "keyword": "文本处理"
}
```

**输出示例**:

```json
{
  "content": [
    {
      "type": "text",
      "text": "关键词搜索结果：\nname: text-processing description: 文本处理工具\n请调用 skill_detail 查技能详情"
    }
  ]
}
```

#### 2.1.2 查看技能详情

- **工具名称**: `skill_detail`
- **工具描述**: 查技能详情
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | name | string | 是 | 技能名称 |

**输入示例**:

```json
{
  "name": "文本处理"
}
```

**输出示例**:

```json
{
  "content": [
    {
      "type": "text",
      "text": "技能详情：\n名称: 文本处理\n描述: 文本处理工具\n详细信息: # 文本处理工具\n\n用于处理文本的工具"
    }
  ]
}
```

#### 2.1.3 保存/更新技能

- **工具名称**: `skill_save`
- **工具描述**: 存技能
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | name | string | 是 | 技能名称 |
  | resource_dir | string | 是 | 资源目录，只能包含字母、数字和下划线 |
  | description | string | 是 | 技能描述 |
  | detail | string | 是 | 技能详情，Markdown格式，包含使用说明、示例代码等 |

**输入示例**:

```json
{
  "name": "文本处理",
  "resource_dir": "text_processing",
  "description": "文本处理工具",
  "detail": "# 文本处理工具\n\n用于处理文本的工具"
}
```

### 2.2 任务管理工具

#### 2.2.1 创建新任务

- **工具名称**: `job_new`
- **工具描述**: 创建新任务，用于跟踪和管理项目中的具体工作任务
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | project | string | 是 | 所属项目 |
  | type | string | 是 | 任务类型，可选值：新需求、Bug修复、改进功能、重构代码、单元测试、集成测试、数据处理、版本控制 |
  | goal | string | 是 | 当前任务核心目标的简要描述，用于复盘和管理 |
  | relatedFiles | string | 是 | 任务涉及的相关文件或文件夹路径，多个文件或文件夹就用逗号分隔 |
  | solution | string | 是 | 达成目标的具体解决思路，包括使用的技能、工具和步骤 |
  | acceptStd | string | 是 | 验收标准，包括：人工验收、测试验收、编译验收 |
  | skills | string | 是 | 使用的技能列表，多个技能用逗号分隔 |

**输入示例**:

```json
{
  "project": "智流MCP",
  "type": "新需求",
  "goal": "实现用户登录功能",
  "relatedFiles": "src/auth/login.go,src/auth/jwt.go",
  "solution": "使用JWT实现token认证， bcrypt加密密码",
  "acceptStd": "测试验收",
  "skills": "go,jwt"
}
```

**输出示例**:

```json
{
  "content": [
    {
      "type": "text",
      "text": "任务创建成功\n任务编号: JT-智流MCP-20250211-001"
    }
  ]
}
```

#### 2.2.2 查询任务详情

- **工具名称**: `job_get`
- **工具描述**: 查询任务详情
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | jobNo | string | 是 | 任务编号 |

#### 2.2.3 报告任务执行结果

- **工具名称**: `job_report`
- **工具描述**: 报告任务执行结果
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | jobNo | string | 是 | 任务编号 |
  | status | string | 是 | 任务状态，可选值：已创建、处理中、处理失败、处理完成、验收通过 |
  | result | string | 是 | 任务执行结果 |
  | passAcceptStd | boolean | 是 | 是否通过验收标准 |

#### 2.2.4 重新执行任务

- **工具名称**: `job_redo`
- **工具描述**: 用新的解决思路执行任务，以达到目标，保持任务编号不变，以便跟踪管理执行情况
- **输入参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | jobNo | string | 是 | 任务编号 |
  | solution | string | 是 | 达成目标的具体解决思路，包括使用的技能、工具和步骤 |
  | relatedFiles | string | 是 | 任务涉及的相关文件或文件夹路径，多个文件或文件夹就用逗号分隔 |
  | skills | string | 否 | 使用的技能列表，多个技能用逗号分隔 |

## 3. 错误代码

| 错误类型 | 错误信息 | 状态码 |
|---------|---------|-------|
| 请求参数错误 | 请求参数错误 | 400 |
| 无效的ID参数 | 无效的ID参数 | 400 |
| 技能不存在 | 技能不存在 | 404 |
| 标签不存在 | 标签不存在 | 404 |
| 任务不存在 | 任务不存在 | 404 |
| 获取数据失败 | 获取数据失败 | 500 |
| 创建数据失败 | 创建数据失败 | 500 |
| 更新数据失败 | 更新数据失败 | 500 |
| 删除数据失败 | 删除数据失败 | 500 |
| 数据库未初始化 | 数据库未初始化 | 500 |
